---
export const prerender = false;

// Cache the page at Cloudflare edge for 30 minutes
// stale-while-revalidate allows serving stale content while fetching fresh
Astro.response.headers.set(
  'Cache-Control',
  'public, s-maxage=1800, stale-while-revalidate=3600'
);

import Layout from '../layouts/Layout.astro';
import EventCard from '../components/EventCard.astro';
import { fetchGoogleCalendarEvents } from '../lib/calendar';
import { generateEventListSchema } from '../lib/schema';
import eventsData from '../data/events.json';

// Try to fetch from Google Calendar, fall back to JSON file
let events;
let calendarError: string | null = null;
let usingFallback = false;

try {
  // Get calendar ID from Cloudflare runtime env vars
  const calendarId = Astro.locals.runtime?.env?.PUBLIC_GOOGLE_CALENDAR_ID;
  events = await fetchGoogleCalendarEvents(calendarId);
  // If no events from calendar, use fallback data
  if (events.length === 0) {
    console.warn('No events from Google Calendar, using fallback data');
    calendarError = 'No events returned from Google Calendar';
    usingFallback = true;
    console.log('ðŸ“… Calendar Debug Info:', { usingFallback, calendarError });
    events = eventsData;
  }
} catch (error) {
  console.error('Error fetching Google Calendar, using fallback data:', error);
  calendarError = error instanceof Error ? error.message : 'Unknown error';
  usingFallback = true;
  console.log('ðŸ“… Calendar Debug Info:', { usingFallback, calendarError, error: error instanceof Error ? error.message : 'Unknown error' });
  events = eventsData;
}

// Sort events by date and time
events = [...events].sort((a, b) => {
  // First compare dates
  const dateComparison = new Date(a.date).getTime() - new Date(b.date).getTime();
  if (dateComparison !== 0) {
    return dateComparison;
  }

  // If dates are the same, compare start times
  // Convert "HH:MM" to minutes for comparison
  const [aHours, aMinutes] = a.startTime.split(':').map(Number);
  const [bHours, bMinutes] = b.startTime.split(':').map(Number);
  const aTimeInMinutes = aHours * 60 + aMinutes;
  const bTimeInMinutes = bHours * 60 + bMinutes;

  return aTimeInMinutes - bTimeInMinutes;
});

// Get current date in Arizona time (UTC-7)
// Create a date in UTC and adjust to Arizona time
const nowUtc = new Date();
const arizonaOffset = -7 * 60; // Arizona is UTC-7
const nowArizona = new Date(nowUtc.getTime() + arizonaOffset * 60 * 1000);
const todayArizona = new Date(nowArizona.getFullYear(), nowArizona.getMonth(), nowArizona.getDate());

// Separate upcoming and past events
// Event dates are stored as "YYYY-MM-DD" strings in Arizona time
const upcomingEvents = events.filter(event => {
  const eventDate = new Date(event.date + 'T00:00:00'); // Parse as local date
  return eventDate >= todayArizona;
});
const pastEvents = events.filter(event => {
  const eventDate = new Date(event.date + 'T00:00:00'); // Parse as local date
  return eventDate < todayArizona;
});

// Generate structured data for upcoming events
const schema = generateEventListSchema(upcomingEvents);

---

<Layout
  title="Events - White Rabbit WCS"
  description="Find West Coast Swing events, socials, and workshops in Phoenix and Arizona."
  schema={schema}
>
  <main class="events-page">
    <div class="container">
      <header class="page-header">
        <h1 class="page-title gradient-text">Events</h1>
        <div class="filters-container">
          <button id="filter-trigger" class="filter-trigger" aria-label="Open filters">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
            </svg>
            <span class="filter-trigger-text">Filters</span>
            <span id="filter-badge" class="filter-badge hidden">2</span>
          </button>

          <div id="filter-dropdown" class="filter-dropdown hidden">
          <div class="filter-section">
            <div class="filter-section-header">Type</div>
            <div class="filter-options">
              <label class="filter-option">
                <input type="radio" name="type" value="all" checked>
                <span>All Events</span>
              </label>
              <label class="filter-option">
                <input type="radio" name="type" value="social">
                <span>Socials</span>
              </label>
              <label class="filter-option">
                <input type="radio" name="type" value="workshop,class">
                <span>Workshops & Classes</span>
              </label>
              <label class="filter-option">
                <input type="radio" name="type" value="competition">
                <span>Competitions</span>
              </label>
            </div>
          </div>

          <div class="filter-divider"></div>

          <div class="filter-section">
            <div class="filter-section-header">City</div>
            <div class="filter-options">
              <label class="filter-option">
                <input type="radio" name="city" value="all" checked>
                <span>All Cities</span>
              </label>
              <label class="filter-option">
                <input type="radio" name="city" value="Phoenix">
                <span>Phoenix</span>
              </label>
              <label class="filter-option">
                <input type="radio" name="city" value="Tucson">
                <span>Tucson</span>
              </label>
              <label class="filter-option">
                <input type="radio" name="city" value="Prescott">
                <span>Prescott</span>
              </label>
            </div>
          </div>
          </div>
        </div>
      </header>

      {upcomingEvents.length > 0 && (
        <section class="events-section">
          <div class="events-list">
            {upcomingEvents.map(event => {
              // Extract city from address (format: "123 Street, Phoenix, AZ 85001")
              const cityMatch = event.address.match(/,\s*([^,]+),\s*AZ/);
              const rawCity = cityMatch ? cityMatch[1].trim() : 'Phoenix';

              // Map Phoenix metro area cities to "Phoenix"
              const phoenixMetro = ['Phoenix', 'Scottsdale', 'Tempe', 'Mesa', 'Glendale', 'Chandler', 'Gilbert', 'Peoria', 'Surprise', 'Avondale'];
              const city = phoenixMetro.some(c => rawCity.toLowerCase().includes(c.toLowerCase())) ? 'Phoenix' : rawCity;

              return (
                <div class="event-item" data-type={event.type} data-city={city}>
                  <EventCard event={event} />
                </div>
              );
            })}
          </div>
        </section>
      )}

      {pastEvents.length > 0 && (
        <section class="events-section past-events">
          <h2 class="section-title">> Past Events</h2>
          <div class="events-list">
            {pastEvents.map(event => {
              // Extract city from address (format: "123 Street, Phoenix, AZ 85001")
              const cityMatch = event.address.match(/,\s*([^,]+),\s*AZ/);
              const rawCity = cityMatch ? cityMatch[1].trim() : 'Phoenix';

              // Map Phoenix metro area cities to "Phoenix"
              const phoenixMetro = ['Phoenix', 'Scottsdale', 'Tempe', 'Mesa', 'Glendale', 'Chandler', 'Gilbert', 'Peoria', 'Surprise', 'Avondale'];
              const city = phoenixMetro.some(c => rawCity.toLowerCase().includes(c.toLowerCase())) ? 'Phoenix' : rawCity;

              return (
                <div class="event-item" data-type={event.type} data-city={city}>
                  <EventCard event={event} />
                </div>
              );
            })}
          </div>
        </section>
      )}

      {upcomingEvents.length === 0 && pastEvents.length === 0 && (
        <div class="no-events">
          <p>No events scheduled yet. Check back soon!</p>
        </div>
      )}
    </div>
  </main>
</Layout>

<style>
  .events-page {
    min-height: calc(100vh - 80px);
  }

  .debug-banner {
    background: #ff9800;
    color: #000;
    padding: 1rem;
    margin-bottom: 2rem;
    border-left: 4px solid #f57c00;
    border-radius: 4px;
  }

  .debug-banner strong {
    display: block;
    margin-bottom: 0.5rem;
    font-size: 1.1rem;
  }

  .debug-banner p {
    margin: 0.25rem 0;
    font-size: 0.9rem;
  }

  .debug-banner a {
    color: #000;
    text-decoration: underline;
    font-weight: 600;
  }

  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 3rem;
    gap: 1rem;
  }

  .page-title {
    font-size: clamp(2.5rem, 8vw, 4rem);
    letter-spacing: 0.1em;
    margin: 0;
  }

  .page-subtitle {
    font-size: 1.1rem;
    color: var(--text-secondary);
    letter-spacing: 0.2em;
    text-transform: uppercase;
  }

  .filters-container {
    position: relative;
    display: flex;
    align-items: flex-start;
    flex-shrink: 0;
  }

  .filter-trigger {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    font-family: var(--font-primary);
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
    min-width: 44px;
    justify-content: center;
  }

  .filter-trigger-text {
    display: none;
  }

  .filter-trigger:hover {
    border-color: var(--accent-primary);
    background-color: var(--bg-primary);
  }

  .filter-trigger svg {
    color: var(--accent-primary);
  }

  .filter-badge {
    position: absolute;
    top: -8px;
    right: -8px;
    background: var(--accent-primary);
    color: var(--bg-primary);
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0.2rem 0.5rem;
    border-radius: 10px;
    min-width: 20px;
    text-align: center;
  }

  .filter-badge.hidden {
    display: none;
  }

  .filter-dropdown {
    position: absolute;
    top: calc(100% + 8px);
    right: 0;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
    min-width: 280px;
    max-height: calc(100vh - 2rem);
    overflow-y: auto;
    z-index: 1000;
    animation: dropdownFadeIn 0.2s ease-out;
  }

  .filter-dropdown.hidden {
    display: none;
  }

  @keyframes dropdownFadeIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .filter-section {
    padding: 1rem;
  }

  .filter-section-header {
    font-size: 0.85rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--accent-primary);
    margin-bottom: 0.75rem;
  }

  .filter-options {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .filter-option {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem 0.75rem;
    cursor: pointer;
    transition: background 0.2s;
  }

  .filter-option:hover {
    background: var(--bg-primary);
  }

  .filter-option input[type="radio"] {
    appearance: none;
    width: 16px;
    height: 16px;
    border: 2px solid var(--border-color);
    border-radius: 50%;
    cursor: pointer;
    position: relative;
    transition: all 0.2s;
  }

  .filter-option input[type="radio"]:checked {
    border-color: var(--accent-primary);
  }

  .filter-option input[type="radio"]:checked::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 8px;
    height: 8px;
    background: var(--accent-primary);
    border-radius: 50%;
  }

  .filter-option span {
    color: var(--text-primary);
    font-size: 0.95rem;
  }

  .filter-divider {
    height: 1px;
    background: var(--border-color);
  }

  .events-section {
    margin-bottom: 4rem;
  }

  .section-title {
    font-size: 1.8rem;
    color: var(--accent-primary);
    margin-bottom: 2rem;
    font-family: var(--font-primary);
  }

  .events-list {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .event-item {
    animation: fadeIn 0.5s ease-out;
  }

  .event-item.hidden {
    display: none;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .past-events {
    opacity: 0.7;
  }

  .past-events .section-title {
    color: var(--text-muted);
  }

  .no-events {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--text-muted);
    font-size: 1.2rem;
  }

  @media (max-width: 768px) {
    .page-header {
      margin-bottom: 2rem;
      align-items: center;
    }

    .page-title {
      font-size: clamp(2rem, 8vw, 3rem);
    }

    /* Mobile: pin dropdown to the top-right of the viewport */
    .filter-dropdown {
      position: fixed;
      top: 16px;
      right: 16px;
      min-width: 260px;
      max-width: calc(100vw - 2rem);
      max-height: calc(100vh - 32px);
    }
  }
</style>

<script>
  // Filter dropdown functionality
  const filterTrigger = document.getElementById('filter-trigger');
  const filterDropdown = document.getElementById('filter-dropdown');
  const filterBadge = document.getElementById('filter-badge');
  const eventItems = document.querySelectorAll('.event-item');
  const typeRadios = document.querySelectorAll<HTMLInputElement>('input[name="type"]');
  const cityRadios = document.querySelectorAll<HTMLInputElement>('input[name="city"]');

  let isDropdownOpen = false;

  // Restore filters from localStorage
  function restoreFilters() {
    const savedTypeFilter = localStorage.getItem('white-rabbit-type-filter') || 'all';
    const savedCityFilter = localStorage.getItem('white-rabbit-city-filter') || 'all';

    // Set the radio buttons to saved values
    typeRadios.forEach(radio => {
      if (radio.value === savedTypeFilter) {
        radio.checked = true;
      }
    });

    cityRadios.forEach(radio => {
      if (radio.value === savedCityFilter) {
        radio.checked = true;
      }
    });

    // Apply the filters
    applyFilters();
  }

  // Save filters to localStorage
  function saveFilters(typeFilter: string, cityFilter: string) {
    localStorage.setItem('white-rabbit-type-filter', typeFilter);
    localStorage.setItem('white-rabbit-city-filter', cityFilter);
  }

  // Toggle dropdown
  filterTrigger?.addEventListener('click', (e) => {
    e.stopPropagation();
    isDropdownOpen = !isDropdownOpen;
    filterDropdown?.classList.toggle('hidden', !isDropdownOpen);
  });

  // Close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    if (isDropdownOpen && !filterDropdown?.contains(e.target as Node)) {
      isDropdownOpen = false;
      filterDropdown?.classList.add('hidden');
    }
  });

  // Prevent dropdown from closing when clicking inside
  filterDropdown?.addEventListener('click', (e) => {
    e.stopPropagation();
  });

  // Apply filters
  function applyFilters() {
    const currentTypeFilter = Array.from(typeRadios).find(r => r.checked)?.value || 'all';
    const currentCityFilter = Array.from(cityRadios).find(r => r.checked)?.value || 'all';

    // Save to localStorage
    saveFilters(currentTypeFilter, currentCityFilter);

    // Update badge
    let activeFilters = 0;
    if (currentTypeFilter !== 'all') activeFilters++;
    if (currentCityFilter !== 'all') activeFilters++;

    if (activeFilters > 0) {
      filterBadge?.classList.remove('hidden');
      if (filterBadge) filterBadge.textContent = activeFilters.toString();
    } else {
      filterBadge?.classList.add('hidden');
    }

    // Filter events
    eventItems.forEach(item => {
      const eventType = item.getAttribute('data-type');
      const eventCity = item.getAttribute('data-city');

      // Handle comma-separated type values (e.g., "workshop,class")
      const allowedTypes = currentTypeFilter.split(',');
      const typeMatch = currentTypeFilter === 'all' || allowedTypes.includes(eventType || '');
      const cityMatch = currentCityFilter === 'all' || eventCity === currentCityFilter;

      if (typeMatch && cityMatch) {
        item.classList.remove('hidden');
      } else {
        item.classList.add('hidden');
      }
    });
  }

  // Listen to radio changes
  typeRadios.forEach(radio => {
    radio.addEventListener('change', applyFilters);
  });

  cityRadios.forEach(radio => {
    radio.addEventListener('change', applyFilters);
  });

  // Restore filters on page load
  restoreFilters();
</script>
