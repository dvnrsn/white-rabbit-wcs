---
import Layout from '../layouts/Layout.astro';
import EventCard from '../components/EventCard.astro';
import { fetchGoogleCalendarEvents } from '../lib/calendar';
import { generateEventListSchema } from '../lib/schema';
import eventsData from '../data/events.json';

// Try to fetch from Google Calendar, fall back to JSON file
let events;
let calendarError: string | null = null;
let usingFallback = false;

try {
  events = await fetchGoogleCalendarEvents();
  // If no events from calendar, use fallback data
  if (events.length === 0) {
    console.warn('No events from Google Calendar, using fallback data');
    calendarError = 'No events returned from Google Calendar';
    usingFallback = true;
    events = eventsData;
  }
} catch (error) {
  console.error('Error fetching Google Calendar, using fallback data:', error);
  calendarError = error instanceof Error ? error.message : 'Unknown error';
  usingFallback = true;
  events = eventsData;
}

// Sort events by date
events = [...events].sort((a, b) => {
  return new Date(a.date).getTime() - new Date(b.date).getTime();
});

// Get current date
const today = new Date();
today.setHours(0, 0, 0, 0);

// Separate upcoming and past events
const upcomingEvents = events.filter(event => new Date(event.date) >= today);
const pastEvents = events.filter(event => new Date(event.date) < today);

// Generate structured data for upcoming events
const schema = generateEventListSchema(upcomingEvents);

---

<Layout
  title="Events - White Rabbit WCS"
  description="Find West Coast Swing events, socials, and workshops in Phoenix and Arizona."
  schema={schema}
>
  <main class="events-page">
    <div class="container">
      <header class="page-header">
        <h1 class="page-title gradient-text">Events</h1>
        <p class="page-subtitle">Phoenix, Arizona</p>
      </header>

      {usingFallback && (
        <div class="debug-banner">
          <strong>⚠️ Calendar Debug Info:</strong>
          <p>Using fallback data. Reason: {calendarError}</p>
          <p>
            <a href="/api/debug-calendar.json" target="_blank">
              View detailed debug info →
            </a>
          </p>
        </div>
      )}

      <div class="events-filters" id="events-filters">
        <button class="filter-btn active" data-filter="all">All Events</button>
        <button class="filter-btn" data-filter="social">Socials</button>
        <button class="filter-btn" data-filter="workshop">Workshops</button>
        <button class="filter-btn" data-filter="competition">Competitions</button>
      </div>

      {upcomingEvents.length > 0 && (
        <section class="events-section">
          <h2 class="section-title">> Upcoming Events</h2>
          <div class="events-list">
            {upcomingEvents.map(event => (
              <div class="event-item" data-type={event.type}>
                <EventCard event={event} />
              </div>
            ))}
          </div>
        </section>
      )}

      {pastEvents.length > 0 && (
        <section class="events-section past-events">
          <h2 class="section-title">> Past Events</h2>
          <div class="events-list">
            {pastEvents.map(event => (
              <div class="event-item" data-type={event.type}>
                <EventCard event={event} />
              </div>
            ))}
          </div>
        </section>
      )}

      {upcomingEvents.length === 0 && pastEvents.length === 0 && (
        <div class="no-events">
          <p>No events scheduled yet. Check back soon!</p>
        </div>
      )}
    </div>
  </main>
</Layout>

<style>
  .events-page {
    padding: 3rem 0;
    min-height: calc(100vh - 80px);
  }

  .debug-banner {
    background: #ff9800;
    color: #000;
    padding: 1rem;
    margin-bottom: 2rem;
    border-left: 4px solid #f57c00;
    border-radius: 4px;
  }

  .debug-banner strong {
    display: block;
    margin-bottom: 0.5rem;
    font-size: 1.1rem;
  }

  .debug-banner p {
    margin: 0.25rem 0;
    font-size: 0.9rem;
  }

  .debug-banner a {
    color: #000;
    text-decoration: underline;
    font-weight: 600;
  }

  .page-header {
    text-align: center;
    margin-bottom: 3rem;
  }

  .page-title {
    font-size: clamp(2.5rem, 8vw, 4rem);
    margin-bottom: 0.5rem;
    letter-spacing: 0.1em;
  }

  .page-subtitle {
    font-size: 1.1rem;
    color: var(--text-secondary);
    letter-spacing: 0.2em;
    text-transform: uppercase;
  }

  .events-filters {
    display: flex;
    gap: 1rem;
    margin-bottom: 3rem;
    flex-wrap: wrap;
    justify-content: center;
  }

  .filter-btn {
    padding: 0.75rem 1.5rem;
    background: transparent;
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.3s;
    font-family: var(--font-primary);
    font-size: 0.9rem;
  }

  .filter-btn:hover {
    border-color: var(--accent-primary);
    color: var(--text-primary);
  }

  .filter-btn.active {
    background: var(--accent-primary);
    border-color: var(--accent-primary);
    color: var(--bg-primary);
  }

  .events-section {
    margin-bottom: 4rem;
  }

  .section-title {
    font-size: 1.8rem;
    color: var(--accent-primary);
    margin-bottom: 2rem;
    font-family: var(--font-primary);
  }

  .events-list {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .event-item {
    animation: fadeIn 0.5s ease-out;
  }

  .event-item.hidden {
    display: none;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .past-events {
    opacity: 0.7;
  }

  .past-events .section-title {
    color: var(--text-muted);
  }

  .no-events {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--text-muted);
    font-size: 1.2rem;
  }

  @media (max-width: 768px) {
    .events-page {
      padding: 2rem 0;
    }

    .page-header {
      margin-bottom: 2rem;
    }

    .events-filters {
      gap: 0.5rem;
    }

    .filter-btn {
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
    }
  }
</style>

<script>
  // Event filtering
  const filterBtns = document.querySelectorAll('.filter-btn');
  const eventItems = document.querySelectorAll('.event-item');

  filterBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const filter = btn.getAttribute('data-filter');

      // Update active button
      filterBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      // Filter events
      eventItems.forEach(item => {
        const eventType = item.getAttribute('data-type');

        if (filter === 'all' || eventType === filter) {
          item.classList.remove('hidden');
        } else {
          item.classList.add('hidden');
        }
      });
    });
  });
</script>
