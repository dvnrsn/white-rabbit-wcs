---
import { Instagram, X } from 'lucide-astro';

interface Props {
  event: {
    id: string;
    title: string;
    description: string;
    date: string;
    startTime: string;
    endTime: string;
    venue: string;
    address: string;
    price: string;
    level: string;
    type: string;
    organizer: string;
    url?: string;
    instagram?: string;
    website?: string;
    isRecurring?: boolean;
  };
}

const { event } = Astro.props;

// Format date
const eventDate = new Date(event.date + "T00:00:00");
const dayName = eventDate.toLocaleDateString("en-US", { weekday: "short" });
const monthName = eventDate.toLocaleDateString("en-US", { month: "short" });
const day = eventDate.getDate();

// Format time
const formatTime = (time: string) => {
  const [hours, minutes] = time.split(":");
  const hour = parseInt(hours);
  const ampm = hour >= 12 ? "PM" : "AM";
  const displayHour = hour % 12 || 12;
  return `${displayHour}:${minutes} ${ampm}`;
};

const typeColors: Record<string, string> = {
  social: "var(--accent-primary)",
  workshop: "var(--accent-secondary)",
  competition: "#8b5cf6",
};

// Clean up venue name
const cleanVenueName = (venue: string) => {
  const venueLower = venue.toLowerCase();

  if (venueLower.includes('creative dance collective')) {
    return 'Creative Dance Collective';
  }
  if (venueLower.includes('imperial ballroom')) {
    return 'Imperial Ballroom';
  }
  if (venueLower.includes('nrg ballroom')) {
    return 'NRG Ballroom';
  }
  if (venueLower.includes('dream dance')) {
    return 'Dream Dance';
  }

  return venue;
};

const displayVenue = cleanVenueName(event.venue);

// Extract Instagram handle from URL
const getInstagramHandle = (url: string) => {
  try {
    const match = url.match(/instagram\.com\/([^\/\?]+)/i);
    return match ? match[1] : null;
  } catch {
    return null;
  }
};

const instagramHandle = event.instagram ? getInstagramHandle(event.instagram) : null;
---

<article class="event-card">
  <span
    class="event-type"
    style={`border-color: ${typeColors[event.type]}`}
  >
    {event.type}
  </span>

  <div class="event-date-badge">
    <div class="date-day">{day}</div>
    <div class="date-month">{monthName}</div>
    <div class="date-weekday">{dayName}</div>
    {event.isRecurring && (
      <span class="recurring-icon">üîÅ</span>
    )}
  </div>

  <div class="event-content">
    <div class="event-header">
      <h3 class="event-title">{event.title}</h3>
    </div>

    <div class="event-details">
      <div class="detail-item">
        <span class="detail-icon">‚è∞</span>
        <span>{formatTime(event.startTime)}</span>
      </div>

      <div class="detail-item">
        <span class="detail-icon">üìç</span>
        <button
          class="venue-link"
          data-venue-button
          data-address={event.address || event.venue}
        >
          {displayVenue}
        </button>
      </div>

      <div class="detail-item detail-item-price">
        <span class="detail-icon">üíµ</span>
        <span>{event.price}</span>
      </div>
    </div>

    <div class="event-footer">
      <span class="event-organizer">by {event.organizer}</span>
      <button
        class="event-link"
        data-event-details={event.id}
        aria-label="View event details"
      >
        ‚Üí
      </button>
    </div>
  </div>
</article>

<dialog data-maps-dialog={event.id}>
  <div class="maps-modal">
    <button class="maps-option" data-maps-option="apple">
      <span>Apple</span>
    </button>
    <button class="maps-option" data-maps-option="google">
      <span>Google</span>
    </button>
  </div>
</dialog>

<dialog data-event-dialog={event.id}>
  <div class="event-dialog-content">
    <button class="dialog-close-x" data-close-event-dialog aria-label="Close">
      <X size={20} />
    </button>

    <h2 class="dialog-title">{event.title}</h2>

    <div class="dialog-meta">
      <div class="dialog-meta-item">
        <span class="detail-icon">‚è∞</span>
        <span>{formatTime(event.startTime)} - {formatTime(event.endTime)}</span>
      </div>
      <div class="dialog-meta-item">
        <span class="detail-icon">üìç</span>
        <span>{displayVenue}</span>
      </div>
      <div class="dialog-meta-item">
        <span class="detail-icon">üíµ</span>
        <span>{event.price}</span>
      </div>
      {event.level && (
        <div class="dialog-meta-item">
          <span class="detail-icon">üéØ</span>
          <span>{event.level}</span>
        </div>
      )}
    </div>

    <div class="dialog-description">
      <p>{event.description}</p>
    </div>

    {instagramHandle && (
      <div class="dialog-instagram-text">
        <Instagram size={16} />
        <a href={event.instagram} target="_blank" rel="noopener noreferrer">
          {instagramHandle}
        </a>
      </div>
    )}

    <button class="dialog-close-btn" data-close-event-dialog>Close</button>
  </div>
</dialog>

<script>
  let currentAddress = "";
  let currentEventId = "";

  // Detect if user is on an Apple device
  const isAppleDevice = /(iPhone|iPad|iPod|Mac)/i.test(navigator.userAgent);

  document.addEventListener("click", (e) => {
    const target = e.target as HTMLElement;
    const venueButton = target.closest("[data-venue-button]");
    const mapsOption = target.closest("[data-maps-option]");
    const eventDetailsButton = target.closest("[data-event-details]");
    const closeEventDialog = target.closest("[data-close-event-dialog]");

    if (venueButton) {
      e.preventDefault();
      currentAddress = (venueButton as HTMLElement).dataset.address || "";
      // Get the event ID from the card
      const card = venueButton.closest(".event-card");
      currentEventId = card?.querySelector("[data-event-details]")?.getAttribute("data-event-details") || "";

      const mapsDialog = document.querySelector(
        `[data-maps-dialog="${currentEventId}"]`
      ) as HTMLDialogElement;

      if (isAppleDevice) {
        // Show modal for Apple devices
        mapsDialog?.showModal();
      } else {
        // Directly open Google Maps for non-Apple devices
        window.location.href = `https://maps.google.com/?q=${encodeURIComponent(currentAddress)}`;
      }
    } else if (mapsOption) {
      const option = (mapsOption as HTMLElement).dataset.mapsOption;
      const query = encodeURIComponent(currentAddress);

      if (option === "apple") {
        window.location.href = `https://maps.apple.com/?q=${query}`;
      } else if (option === "google") {
        window.location.href = `https://maps.google.com/?q=${query}`;
      }

      const mapsDialog = document.querySelector(
        `[data-maps-dialog="${currentEventId}"]`
      ) as HTMLDialogElement;
      mapsDialog?.close();
    } else if (eventDetailsButton) {
      const eventId = (eventDetailsButton as HTMLElement).getAttribute("data-event-details");
      const eventDialog = document.querySelector(
        `[data-event-dialog="${eventId}"]`
      ) as HTMLDialogElement;
      eventDialog?.showModal();
    } else if (closeEventDialog) {
      // Find the dialog that contains this button
      const dialog = closeEventDialog.closest("dialog") as HTMLDialogElement;
      dialog?.close();
    }
  });

  // Close dialogs when clicking backdrop (using event delegation)
  document.addEventListener("click", (e) => {
    const target = e.target as HTMLElement;
    if (target.tagName === "DIALOG") {
      (target as HTMLDialogElement).close();
    }
  });
</script>

<style>
  .event-card {
    position: relative;
    display: flex;
    gap: 1.5rem;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    padding: 1.5rem;
    transition: all 0.3s;
  }

  .event-card:hover {
    border-color: var(--border-accent);
    box-shadow: var(--shadow-card);
    transform: translateY(-2px);
  }

  .event-date-badge {
    flex-shrink: 0;
    width: 80px;
    height: 80px;
    background: var(--bg-primary);
    border: 2px solid var(--accent-primary);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    position: relative;
  }

  .recurring-icon {
    position: absolute;
    bottom: 4px;
    right: 4px;
    font-size: 0.85rem;
    opacity: 0.7;
  }

  .date-day {
    font-size: 2rem;
    font-weight: 700;
    color: var(--accent-primary);
    line-height: 1;
  }

  .date-month {
    font-size: 0.9rem;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .date-weekday {
    font-size: 0.75rem;
    color: var(--text-muted);
    text-transform: uppercase;
  }

  .event-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .event-header {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .event-title {
    font-size: 1.5rem;
    color: var(--text-primary);
    margin: 0;
  }

  .event-type {
    position: absolute;
    top: 1rem;
    right: 1rem;
    font-size: 0.75rem;
    text-transform: uppercase;
    padding: 0.25rem 0.75rem;
    border: 1px solid;
    color: var(--text-secondary);
    white-space: nowrap;
    letter-spacing: 0.05em;
    background: var(--bg-secondary);
    z-index: 1;
  }

  .event-description {
    color: var(--text-secondary);
    line-height: 1.6;
    margin: 0;
  }

  .event-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 0.75rem;
  }

  .detail-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
    color: var(--text-secondary);
  }

  .detail-icon {
    font-size: 1rem;
  }

  .event-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding-top: 1rem;
    border-top: 1px solid var(--border-color);
  }

  .event-organizer {
    font-size: 0.85rem;
    color: var(--text-muted);
  }

  .event-link {
    background: none;
    border: none;
    color: var(--accent-primary);
    text-decoration: none;
    font-size: 1.5rem;
    transition: all 0.2s;
    font-weight: 500;
    cursor: pointer;
    padding: 0;
    font-family: inherit;
  }

  .event-link:hover {
    color: var(--text-primary);
    transform: translateX(4px);
  }

  dialog[data-event-dialog] {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    margin: 0;
    background: var(--bg-primary);
    border: 2px solid var(--border-accent);
    padding: 0;
    box-shadow: var(--shadow-card);
    width: 95vw;
    max-width: 900px;
    max-height: 90vh;
    overflow-y: auto;
  }

  dialog[data-event-dialog]::backdrop {
    position: fixed;
    inset: 0;
    width: 100vw;
    min-height: 100vh;
    min-height: 100dvh;
    height: 200vh;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
  }

  .event-dialog-content {
    padding: 2rem;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    position: relative;
  }

  .dialog-close-x {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: color 0.2s;
  }

  .dialog-close-x:hover {
    color: var(--text-primary);
  }

  @media (max-width: 640px) {
    .dialog-close-x {
      display: none;
    }
  }

  .dialog-title {
    color: var(--text-primary);
    margin: 0;
    font-size: 1.75rem;
    padding-right: 2rem;
  }

  .dialog-meta {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    padding: 1rem;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
  }

  .dialog-meta-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    color: var(--text-secondary);
  }

  .dialog-description {
    color: var(--text-secondary);
    line-height: 1.6;
  }

  .dialog-description p {
    margin: 0;
    white-space: pre-wrap;
  }

  .dialog-instagram-text {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--text-secondary);
    font-size: 0.95rem;
  }

  .dialog-instagram-text a {
    color: var(--accent-primary);
    text-decoration: none;
    transition: color 0.2s;
  }

  .dialog-instagram-text a:hover {
    color: var(--text-primary);
  }

  .dialog-close-btn {
    padding: 0.75rem 1.5rem;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.2s;
    font-family: inherit;
    font-size: 0.9rem;
    display: none;
  }

  .dialog-close-btn:hover {
    border-color: var(--accent-primary);
    color: var(--accent-primary);
  }

  @media (max-width: 640px) {
    .dialog-close-btn {
      display: block;
    }
  }

  .venue-link {
    color: var(--text-secondary);
    background: none;
    border: none;
    border-bottom: 1px dashed var(--border-color);
    padding: 0;
    font-size: inherit;
    font-family: inherit;
    cursor: pointer;
    transition: all 0.2s;
  }

  .venue-link:hover {
    color: var(--accent-primary);
    border-bottom-color: var(--accent-primary);
  }

  dialog[data-maps-dialog] {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    margin: 0;
    background: var(--bg-primary);
    border: 2px solid var(--border-accent);
    padding: 0;
    box-shadow: var(--shadow-card);
    max-width: 90vw;
  }

  dialog[data-maps-dialog]::backdrop {
    position: fixed;
    inset: 0;
    width: 100vw;
    min-height: 100vh;
    min-height: 100dvh;
    height: 200vh;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
  }

  html:has(dialog[data-maps-dialog][open]),
  body:has(dialog[data-maps-dialog][open]),
  html:has(dialog[data-event-dialog][open]),
  body:has(dialog[data-event-dialog][open]) {
    overflow: hidden;
  }

  .maps-modal {
    padding: 1.5rem;
    display: flex;
    gap: 1rem;
  }

  .maps-option {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    padding: 1.5rem 2rem;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.2s;
    font-family: inherit;
    font-size: 0.9rem;
  }

  .maps-option:hover {
    border-color: var(--accent-primary);
    color: var(--accent-primary);
    transform: translateY(-2px);
  }

  .maps-icon {
    font-size: 2rem;
  }

  @media (max-width: 640px) {
    .event-card {
      flex-direction: column;
    }

    .event-date-badge {
      width: 100%;
      height: 60px;
      flex-direction: row;
      justify-content: center;
      gap: 1rem;
    }

    .date-day {
      font-size: 1.5rem;
    }

    .event-header {
      flex-direction: column;
    }

    .event-details {
      grid-template-columns: 1fr;
    }

    .detail-item-price {
      display: none;
    }
  }
</style>
